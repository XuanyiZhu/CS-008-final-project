<?php
include 'top.php';
?>
<?php
foreach ($records as $oneRecord) {
    if ($oneRecord[0] == $showId) {
        print "<h1>" . $oneRecord[2] . "</h1>";
        print '<img src="img/' . $oneRecord[8] . '">';
        $price = $oneRecord[6];
    }
}
$debug = false;
if (isset($_GET["debug"])) {
    $debug = true;
}
if ($debug) {
    print "<p>DEBUG MODE IS ON</p>";
}
$yourURL = $domain . $phpSelf . '?id=' . $showId;
$time = "";
$email = "";
$uvmstudent = "";
$adult = "";
$senior = "";
$seat = "Center";


$ticketERROE = FALSE;
$emailERROR = FALSE;
$timeERROR = FALSE;
$seatERROR = FALSE;

$errorMsg = array();
$dataRecord = array();

if (isset($_POST["btnSubmit"])) {
    if (!securityCheck(true)) {
        $msg = "<p>Sorry you cannot access this page. ";
        $msg.= "Security breach detected and reported</p>";
        die($msg);
    }
    $_SESSION["j"] = $_SESSION["j"] + 1;
    $_SESSION["price" . $_SESSION["j"]] = $price;
    $_SESSION["showId" . $_SESSION["j"]] = $showId;
    $email = filter_var($_POST["txtEmail"], FILTER_SANITIZE_EMAIL);
    $_SESSION["email" . $_SESSION["j"]] = $email;
    $time = htmlentities($_POST["radTime"], ENT_QUOTES, "UTF-8");
    $_SESSION["time" . $_SESSION["j"]] = $time;
    $adult = htmlentities($_POST["lstAdult"], ENT_QUOTES, "UTF-8");
    $_SESSION["adult" . $_SESSION["j"]] = $adult;
    $uvmstudent = htmlentities($_POST["lstUvmStudent"], ENT_QUOTES, "UTF-8");
    $_SESSION["uvmstudent" . $_SESSION["j"]] = $uvmstudent;
    $senior = htmlentities($_POST["lstSenior"], ENT_QUOTES, "UTF-8");
    $_SESSION["senior" . $_SESSION["j"]] = $senior;
    $seat = htmlentities($_POST["radSeat"], ENT_QUOTES, "UTF-8");
    $_SESSION["seat" . $_SESSION["j"]] = $seat;

    if ($email == "") {
        $errorMsg[] = "Please enter your email address";
        $emailERROR = true;
    } elseif (!verifyEmail($email)) {
        $errorMsg[] = "Your email address appears to be incorrect.";
        $emailERROR = true;
    }

    if ($senior == "0" && $uvmstudent == "0" && $adult == "0") {
        $errorMsg[] = "please select at least one ticket";
        $ticketERROR = true;
    }
    if ($time == "") {
        $errorMsg[] = "please select one time";
        $timeERROR = true;
    }
    if ($seat == "") {
        $errorMsg[] = "please select prefer seatting are";
        $seatERROR = true;
    }

    if (!$errorMsg) {
        if ($debug)
            print "<p>Form is valid</p>";

        $message = '<h2>Your information.</h2>';
        foreach ($_POST as $key => $value) {
            if ($key != 'btnSubmit') {
                $message .= "<p>";
                $camelCase = preg_split('/(?=[A-Z])/', substr($key, 3));
                foreach ($camelCase as $one) {
                    $message .= $one . " ";
                }
                $message .= " = " . htmlentities($value, ENT_QUOTES, "UTF-8") . "</p>";
            }
        }

        $todaysDate = strftime("%x");
    } // end form is valid
} // ends if form was submitted.
?>

<article id="main1">
    <?php
    if (isset($_POST["btnSubmit"]) AND empty($errorMsg)) { // closing of if marked with: end body submit
        print $message;
    } else {
        if ($errorMsg) {
            print '<div id="errors">';
            print '<h1>Here is the list of your error:</h1>';
            print "<ol>\n";
            foreach ($errorMsg as $err) {
                print "<li>" . $err . "</li>\n";
            }
            print "</ol>\n";
            print '</div>';
        }
    }
    ?>
</article>

<article id="main2">
    <form action="<?php print $phpSelf . '?id=' . $showId; ?>"
          method="post"
          id="frmRegister">
        <label for="lstAdult">Adult</label>
        <select id="lstAdult" 
                name="lstAdult" 
                tabindex="400" >

            <option <?php if ($adult == "0") print" selected "; ?>
                value="0">0</option>
            <option <?php if ($adult == "1") print" selected "; ?>
                value="1">1</option>
            <option <?php if ($adult == "2") print" selected "; ?>
                value="2">2</option>
            <option <?php if ($adult == "3") print" selected "; ?>
                value="3">3</option>
            <option <?php if ($adult == "4") print" selected "; ?>
                value="4">4</option>
            <option <?php if ($adult == "5") print" selected "; ?>
                value="5">5</option>
        </select>

        <label for="lstUvmStudent">UVM Students</label>
        <select id="lstUvmStudent" 
                name="lstUvmStudent" 
                tabindex="400" >

            <option <?php if ($uvmstudent == "0") print" selected "; ?>
                value="0">0</option>
            <option <?php if ($uvmstudent == "1") print" selected "; ?>
                value="1">1</option>
            <option <?php if ($uvmstudent == "2") print" selected "; ?>
                value="2">2</option>
            <option <?php if ($uvmstudent == "3") print" selected "; ?>
                value="3">3</option>
            <option <?php if ($uvmstudent == "4") print" selected "; ?>
                value="4">4</option>
            <option <?php if ($uvmstudent == "5") print" selected "; ?>
                value="5">5</option>
        </select>

        <label for="lstSenior">Senior</label>
        <select id="lstSenior" 
                name="lstSenior" 
                tabindex="400" >

            <option <?php if ($senior == "0") print" selected "; ?>
                value="0">0</option>
            <option <?php if ($senior == "1") print" selected "; ?>
                value="1">1</option>
            <option <?php if ($senior == "2") print" selected "; ?>
                value="2">2</option>
            <option <?php if ($senior == "3") print" selected "; ?>
                value="3">3</option>
            <option <?php if ($senior == "4") print" selected "; ?>
                value="4">4</option>
            <option <?php if ($senior == "5") print" selected "; ?>
                value="5">5</option>
        </select>




        <fieldset>
            <legend>Choose a time: </legend>
            <label class="radio"></label>
<?php
foreach ($records as $oneRecord) {
    if ($oneRecord[0] == $showId) {
        for ($i = 10; $oneRecord[$i] != ""; $i++) {
            print'<input type="radio" 
               id="rad' . $oneRecord[$i] . '" 
               name="radTime" 
               value="' . $oneRecord[$i] . '"';
            ?>

                        <?php if ($time == $oneRecord[$i]) print 'checked' ?>
                        <?php
                        print'tabindex = "330">' . $oneRecord[$i];
//
                        print'<p>$time: ' . $time . '</p>';
                        print'<p>$oneRecord: ' . "$oneRecord[$i]" . '</p>';
                        if ($time == $oneRecord[$i]) {
                            print'<p>true:</p>';
                        } else {
                            print"<p>false</p>";
                        }
                    }
                }
            }

            foreach ($records as $oneRecord) {
                if ($oneRecord[0] == $showId) {
                    $price = $oneRecord[6];
                }
            }
            ?>
        </fieldset>

        <fieldset>

            <legend>Where would you prefer to seat?: </legend>
            <div class="example">
                <div>
                    <input id="radSeatSideLeft" type="radio" name="radSeat" value="Side Left" <?php if ($seat == "Side Left") print 'checked="checked"' ?>><label for="radio1">Side Left</label>
                </div>
                <div>
                    <input id="radCenter" type="radio" name="radSeat" value="Center"><label for="radio2" <?php if ($seat == "Center") print 'checked="checked"' ?>>Center (+ $4)</label>
                </div>
                <div>
                    <input id="radSeatSideRight" type="radio" name="radSeat" value="Side Right" <?php if ($seat == "Side Right") print 'checked="checked"' ?>><label for="radio3">Side Right</label>
                </div>
            </div>

        </fieldset>


        <label for="txtEmail" class="required">Email
            <input type="text" id="txtEmail" name="txtEmail"
                   value="<?php print $email; ?>"
                   tabindex="120" maxlength="70" placeholder="Enter a valid email address"

                   onfocus="this.select()" 
                   autofocus>
        </label>


        <fieldset class="buttons">
            <legend></legend>
            <input type="submit" id="btnSubmit" name="btnSubmit" value="Add to cart" tabindex="900" class="button">
        </fieldset>
    </form>
</article>

<?php include "footer.php"; ?>
</body>
</html>



